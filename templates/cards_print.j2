<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ title }}</title>
  <link rel="stylesheet" href="../assets/cards_print.css">
</head>
<body>
  <button class="theme-toggle" id="themeToggle" title="Toggle dark mode">ðŸŒ™</button>
  <div class="cards-container">
    {% for c in cards %}
      <div class="card {{ c.type }}-card">
        <div class="card-header">
          <div class="card-title">
            <span class="card-name">{{ c.name }}</span>
          </div>
          {% if c.subtitle %}<i class="card-category">{{ c.subtitle }}</i>{% endif %}
        </div>
        {% if c.type == 'archetype' %}
          {% include "_archetype_card.j2" %}
        {% elif c.type == 'bias' %}
          {% include "_bias_dice_card.j2" %}
        {% elif c.type == 'emotion' %}
          {% include "_emotion_card.j2" %}
        {% else %}
          {% include "_archetype_card.j2" %}
        {% endif %}
        {% if c.quote %}<div class="card-footer">{{ c.quote }}</div>{% endif %}
      </div>
    {% endfor %}
  </div>
  <script>
    (function() {
      // theme toggle
      (function(){
        var key = 'theme';
        var saved = localStorage.getItem(key);
        var hour = new Date().getHours();
        var isNight = (hour >= 21 || hour < 5);
        if (saved === 'dark' || (!saved && (isNight || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)))) {
          document.body.classList.add('dark');
        }
        var btn = document.getElementById('themeToggle');
        if (btn) btn.addEventListener('click', function(){
          var d = document.body.classList.toggle('dark');
          localStorage.setItem(key, d ? 'dark' : 'light');
        });
      })();

      function fitTitle(el) {
        if (!el) return;
        var computed = window.getComputedStyle(el);
        var size = parseFloat(computed.fontSize) || 20;
        var minSize = 10;
        var parentWidth = el.parentElement ? el.parentElement.clientWidth : el.clientWidth;
        el.style.whiteSpace = 'nowrap';
        el.style.display = 'inline-block';
        el.style.maxWidth = '100%';
        el.style.width = 'fit-content';
        el.style.fontSize = size + 'px';
        var guard = 120;
        // shrink only if content exceeds the available width
        while (el.getBoundingClientRect().width > parentWidth && size > minSize && guard-- > 0) {
          size -= 0.5;
          el.style.fontSize = size + 'px';
        }
        console.log("Shrunk title to " + el.style.fontSize);
      }
      function fitAll() {
        document.querySelectorAll('.card-name').forEach(fitTitle);
        document.querySelectorAll('.card-body').forEach(fitRules);
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', fitAll);
      } else {
        fitAll();
      }
      window.addEventListener('load', fitAll);
      window.addEventListener('resize', fitAll);
      window.matchMedia('print').addListener(fitAll);
    })();
    // Resize rules text to fit within the card bounds
    function fitRules(panel) {
      try {
        if (!panel) return;
        var text = panel.textContent || '';
        if (text.length > 500) {
          panel.style.fontSize = '9px';
          panel.style.lineHeight = '1.1';
        } else {
          panel.style.fontSize = '';
          panel.style.lineHeight = '';
        }
      } catch (e) { /* no-op */ }
    }
  </script>
</body>
</html>
